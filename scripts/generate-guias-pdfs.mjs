#!/usr/bin/env node

import pkg from 'jspdf'
const { jsPDF } = pkg
import fs from 'fs'
import path from 'path'
import { fileURLToPath } from 'url'

const __filename = fileURLToPath(import.meta.url)
const __dirname = path.dirname(__filename)

// Crear directorio de salida
const outputDir = path.join(__dirname, '..', 'public', 'docs', 'guias')
if (!fs.existsSync(outputDir)) {
  fs.mkdirSync(outputDir, { recursive: true })
  console.log(`‚úÖ Directorio creado: ${outputDir}`)
}

const fechaActual = new Date().toLocaleDateString('es-ES', {
  day: 'numeric',
  month: 'long',
  year: 'numeric'
})

// ============================================================
// FUNCI√ìN: Agregar portada
// ============================================================
function addPortada(doc, titulo, subtitulo) {
  const pageWidth = doc.internal.pageSize.getWidth()
  const pageHeight = doc.internal.pageSize.getHeight()

  // Fondo azul Custodia360
  doc.setFillColor(37, 99, 235)
  doc.rect(0, 0, pageWidth, pageHeight, 'F')

  // Logo simulado (c√≠rculo con C)
  doc.setFillColor(255, 255, 255)
  doc.circle(pageWidth / 2, 60, 18, 'F')
  doc.setTextColor(37, 99, 235)
  doc.setFontSize(28)
  doc.setFont('helvetica', 'bold')
  doc.text('C', pageWidth / 2, 66, { align: 'center' })

  // T√≠tulo principal
  doc.setTextColor(255, 255, 255)
  doc.setFontSize(24)
  doc.text('Custodia360', pageWidth / 2, 95, { align: 'center' })

  // T√≠tulo del documento
  doc.setFontSize(20)
  const tituloLineas = doc.splitTextToSize(titulo, pageWidth - 40)
  let yPos = 125
  tituloLineas.forEach(linea => {
    doc.text(linea, pageWidth / 2, yPos, { align: 'center' })
    yPos += 10
  })

  // Subt√≠tulo
  doc.setFontSize(12)
  doc.setFont('helvetica', 'normal')
  const subtituloLineas = doc.splitTextToSize(subtitulo, pageWidth - 50)
  yPos += 10
  subtituloLineas.forEach(linea => {
    doc.text(linea, pageWidth / 2, yPos, { align: 'center' })
    yPos += 6
  })

  // Versi√≥n y fecha
  doc.setFontSize(11)
  doc.text('Versi√≥n 1.0', pageWidth / 2, pageHeight - 50, { align: 'center' })
  doc.text(fechaActual, pageWidth / 2, pageHeight - 38, { align: 'center' })

  // Disclaimer
  doc.setFontSize(8)
  doc.setFont('helvetica', 'italic')
  const disclaimer = 'Esta gu√≠a es informativa y no sustituye el asesoramiento legal. Para la implantaci√≥n completa, automatizaci√≥n y seguimiento profesional, contacte con Custodia360.'
  const disclaimerLineas = doc.splitTextToSize(disclaimer, pageWidth - 50)
  yPos = pageHeight - 25
  disclaimerLineas.forEach(linea => {
    doc.text(linea, pageWidth / 2, yPos, { align: 'center' })
    yPos += 4
  })
}

// ============================================================
// FUNCI√ìN: Agregar p√°gina de contenido
// ============================================================
function addContenidoPagina(doc, titulo, contenido, pageNum) {
  const pageWidth = doc.internal.pageSize.getWidth()
  const margin = 20
  const maxWidth = pageWidth - 2 * margin

  // Header
  doc.setFillColor(37, 99, 235)
  doc.rect(0, 0, pageWidth, 18, 'F')
  doc.setTextColor(255, 255, 255)
  doc.setFontSize(9)
  doc.setFont('helvetica', 'bold')
  doc.text('Custodia360', margin, 12)
  doc.text(`P√°gina ${pageNum}`, pageWidth - margin, 12, { align: 'right' })

  // T√≠tulo de secci√≥n
  doc.setTextColor(37, 99, 235)
  doc.setFontSize(14)
  doc.setFont('helvetica', 'bold')
  let yPos = 35
  const tituloLineas = doc.splitTextToSize(titulo, maxWidth)
  tituloLineas.forEach(linea => {
    doc.text(linea, margin, yPos)
    yPos += 7
  })

  // L√≠nea separadora
  doc.setDrawColor(37, 99, 235)
  doc.setLineWidth(0.5)
  doc.line(margin, yPos + 2, pageWidth - margin, yPos + 2)
  yPos += 8

  // Contenido
  doc.setTextColor(50, 50, 50)
  doc.setFontSize(10)
  doc.setFont('helvetica', 'normal')

  contenido.forEach(parrafo => {
    if (parrafo.startsWith('###')) {
      // Subt√≠tulo
      doc.setFont('helvetica', 'bold')
      doc.setFontSize(11)
      doc.setTextColor(37, 99, 235)
      const subtitulo = parrafo.replace('### ', '')
      doc.text(subtitulo, margin, yPos)
      yPos += 7
      doc.setFont('helvetica', 'normal')
      doc.setFontSize(10)
      doc.setTextColor(50, 50, 50)
    } else if (parrafo.startsWith('- ')) {
      // Lista
      const texto = parrafo.replace('- ', '')
      const lineas = doc.splitTextToSize(`‚Ä¢ ${texto}`, maxWidth - 5)
      lineas.forEach(linea => {
        if (yPos > 270) {
          doc.addPage()
          yPos = 25
        }
        doc.text(linea, margin + 3, yPos)
        yPos += 5
      })
    } else {
      // P√°rrafo normal
      const lineas = doc.splitTextToSize(parrafo, maxWidth)
      lineas.forEach(linea => {
        if (yPos > 270) {
          doc.addPage()
          yPos = 25
        }
        doc.text(linea, margin, yPos)
        yPos += 5
      })
      yPos += 2
    }
  })
}

// ============================================================
// GENERAR PDF 1: GU√çA LOPIVI COMPLETA
// ============================================================
console.log('\nüìò Generando Gu√≠a LOPIVI Completa...')

const pdfLopivi = new jsPDF()

// Portada
addPortada(
  pdfLopivi,
  'Gu√≠a LOPIVI Completa',
  'Ley Org√°nica de Protecci√≥n Integral a la Infancia y la Adolescencia frente a la Violencia'
)

// Contenido del PDF
const contenidoLopivi = [
  {
    titulo: 'Introducci√≥n',
    contenido: [
      'La LOPIVI refuerza la prevenci√≥n, detecci√≥n y actuaci√≥n frente a cualquier forma de violencia hacia la infancia y adolescencia.',
      'Esta gu√≠a ayuda a centros educativos, entidades deportivas, asociaciones, academias y organizaciones sociales a comprender sus obligaciones legales y a implantar un sistema de protecci√≥n eficaz.',
      '### Objetivos de esta gu√≠a:',
      '- Explicar el marco legal y los principios fundamentales de la LOPIVI',
      '- Detallar las obligaciones espec√≠ficas seg√∫n el tipo de entidad',
      '- Describir los protocolos de actuaci√≥n y formaci√≥n del personal',
      '- Mostrar casos reales para fomentar la prevenci√≥n activa'
    ]
  },
  {
    titulo: 'Marco Legal Completo',
    contenido: [
      'La protecci√≥n de menores en Espa√±a se sustenta en un marco normativo robusto:',
      '### Constituci√≥n Espa√±ola',
      '- Art√≠culo 39: Protecci√≥n social, econ√≥mica y jur√≠dica de la familia y la infancia',
      '### Convenci√≥n de Derechos del Ni√±o (1989)',
      '- Tratado internacional ratificado por Espa√±a que establece los derechos inalienables de la infancia',
      '### Ley Org√°nica 8/2021 (LOPIVI)',
      '- Protecci√≥n Integral a la Infancia y la Adolescencia frente a la Violencia',
      '- Entrada en vigor: 25 de junio de 2021',
      '- Obligatoria para todas las entidades que trabajan con menores',
      '### Legislaci√≥n Complementaria',
      '- Normativa educativa, deportiva, de ocio y tiempo libre',
      '- Protocolos de servicios sociales y sanitarios',
      '- Ley Org√°nica 3/2018 de Protecci√≥n de Datos'
    ]
  },
  {
    titulo: 'Obligaciones Espec√≠ficas de las Entidades',
    contenido: [
      'La LOPIVI establece obligaciones fundamentales para todas las entidades que trabajan con menores:',
      '### 1. Pol√≠tica Escrita de Protecci√≥n',
      'Documento oficial que establece el compromiso de la entidad con la protecci√≥n de la infancia.',
      '### 2. C√≥digo de Conducta',
      'Normas claras de comportamiento para todo el personal que establece l√≠mites apropiados.',
      '### 3. Nombramiento del Responsable de Protecci√≥n',
      'Designaci√≥n obligatoria de un delegado principal y uno suplente con formaci√≥n especializada.',
      '### 4. Creaci√≥n del Plan de Protecci√≥n',
      'Documento operativo que incluye an√°lisis de riesgos y medidas preventivas.',
      '### 5. Protocolos de Actuaci√≥n',
      'Procedimientos claros para detectar, evaluar y responder ante situaciones de riesgo.',
      '### 6. Formaci√≥n Obligatoria del Personal',
      'Todo el personal debe recibir formaci√≥n inicial y continua en protecci√≥n infantil.',
      '### 7. Canal de Comunicaci√≥n Seguro',
      'Sistema confidencial para reportar sospechas o situaciones de riesgo.',
      '### Registro y Seguimiento',
      '- Formaciones realizadas y certificaciones obtenidas',
      '- Incidencias reportadas y actuaciones realizadas',
      '- Revisiones del sistema de protecci√≥n'
    ]
  },
  {
    titulo: 'Protocolos de Actuaci√≥n - Detecci√≥n',
    contenido: [
      'La detecci√≥n temprana es fundamental para intervenir eficazmente.',
      '### Se√±ales F√≠sicas',
      '- Lesiones inexplicables o frecuentes',
      '- Marcas compatibles con maltrato',
      '- Descuido en higiene personal',
      '- Cambios bruscos de peso',
      '### Se√±ales Conductuales',
      '- Cambios significativos en el comportamiento',
      '- Miedo o rechazo a personas espec√≠ficas',
      '- Conductas regresivas',
      '- Conocimiento sexual inapropiado para la edad',
      '### Se√±ales Emocionales',
      '- Ansiedad o tristeza persistentes',
      '- Baja autoestima',
      '- Dificultades de concentraci√≥n',
      '- Trastornos del sue√±o',
      '### Indicadores Online',
      '- Cambios en el uso de dispositivos',
      '- Secretismo con la actividad online',
      '- Contactos desconocidos',
      '- Contenido inapropiado'
    ]
  },
  {
    titulo: 'Protocolos de Actuaci√≥n - Notificaci√≥n',
    contenido: [
      'Cuando se detecta una situaci√≥n de riesgo, es fundamental activar el protocolo.',
      '### V√≠as Internas',
      '- Comunicaci√≥n inmediata al Delegado de Protecci√≥n',
      '- Uso del canal seguro y confidencial',
      '- Registro documental con fecha y hora',
      '- Preservaci√≥n de evidencias',
      '### V√≠as Externas',
      '- Servicios Sociales del municipio',
      '- Fuerzas y Cuerpos de Seguridad (si hay delito)',
      '- Fiscal√≠a de Menores (casos urgentes)',
      '- Servicios sanitarios (atenci√≥n m√©dica)',
      '### Plazos de Respuesta',
      '- Notificaci√≥n interna: Inmediata (m√°ximo 24 horas)',
      '- Evaluaci√≥n inicial: 24-48 horas',
      '- Derivaci√≥n externa: 72 horas (seg√∫n gravedad)',
      '- Seguimiento: Continuo hasta resoluci√≥n'
    ]
  },
  {
    titulo: 'Formaci√≥n del Personal',
    contenido: [
      'La formaci√≥n es un pilar fundamental del sistema de protecci√≥n.',
      '### Formaci√≥n Inicial Obligatoria',
      'Seg√∫n el art√≠culo 35 de la LOPIVI, todo el personal debe recibir formaci√≥n espec√≠fica.',
      '### Contenidos M√≠nimos',
      '- Marco legal LOPIVI',
      '- Derechos de la infancia',
      '- Identificaci√≥n de se√±ales de riesgo',
      '- Protocolos de actuaci√≥n',
      '- C√≥digo de conducta',
      '- Comunicaci√≥n con menores',
      '- Confidencialidad y protecci√≥n de datos',
      '### Reciclajes Anuales',
      '- Cambios normativos',
      '- Nuevos riesgos (ciberacoso, grooming)',
      '- Buenas pr√°cticas',
      '- Casos pr√°cticos y simulaciones',
      '### Capacitaci√≥n en Comunicaci√≥n',
      '- Escucha activa',
      '- Lenguaje apropiado seg√∫n edad',
      '- Manejo de revelaciones',
      '- Apoyo emocional'
    ]
  },
  {
    titulo: 'Casos Pr√°cticos Reales',
    contenido: [
      '### Caso 1: Centro Educativo - Detecci√≥n Temprana',
      'Un profesor observa cambios significativos en una alumna de 9 a√±os: tristeza, aislamiento, bajo rendimiento y marcas en los brazos.',
      'Actuaci√≥n: Documenta observaciones, comunica al Delegado, escucha activa con la menor, notificaci√≥n a Servicios Sociales.',
      'Resultado: Intervenci√≥n familiar temprana, medida de protecci√≥n, seguimiento coordinado.',
      '### Caso 2: Club Deportivo - Rumor No Verificado',
      'Circula rumor sobre comportamientos inapropiados de un entrenador.',
      'Actuaci√≥n: Protocolo activado, entrevistas confidenciales, revisi√≥n de normativa, suspensi√≥n cautelar durante investigaci√≥n.',
      'Resultado: Se constatan violaciones del c√≥digo de conducta (mensajes privados), separaci√≥n del entrenador, refuerzo formativo.',
      '### Caso 3: Asociaci√≥n Juvenil - Ciberacoso',
      'Durante un campamento, un menor es v√≠ctima de ciberacoso por compa√±eros.',
      'Actuaci√≥n: Detecci√≥n de ansiedad, conversaci√≥n privada, activaci√≥n protocolo, retirada de contenido, notificaci√≥n familias.',
      'Resultado: Taller de redes sociales, mediaci√≥n, seguimiento psicol√≥gico, actualizaci√≥n de normas.'
    ]
  },
  {
    titulo: 'Conclusi√≥n',
    contenido: [
      'El cumplimiento de la LOPIVI requiere estructura, formaci√≥n, evidencia documental y seguimiento continuo.',
      '### Elementos Clave del √âxito',
      '- Compromiso de la direcci√≥n',
      '- Formaci√≥n continua del personal',
      '- Protocolos claros y accesibles',
      '- Cultura de protecci√≥n',
      '- Documentaci√≥n y trazabilidad',
      '- Evaluaci√≥n y mejora continua',
      '### Beneficios',
      '- Protecci√≥n efectiva de menores',
      '- Cumplimiento legal',
      '- Confianza de familias',
      '- Ambiente seguro',
      '- Reducci√≥n de riesgos',
      '### Custodia360: Soluci√≥n Integral',
      'Custodia360 ofrece la primera plataforma automatizada especializada en cumplimiento LOPIVI.',
      'Permite automatizar implementaci√≥n, mantener trazabilidad, auditar en tiempo real, formar y certificar personal, y gestionar casos de forma segura.',
      'M√°s informaci√≥n: www.custodia360.es | info@custodia360.es | Tel: 678 771 198'
    ]
  }
]

let pageNum = 2
contenidoLopivi.forEach(seccion => {
  pdfLopivi.addPage()
  addContenidoPagina(pdfLopivi, seccion.titulo, seccion.contenido, pageNum)
  pageNum++
})

const outputPath1 = path.join(outputDir, 'guia-lopivi-completa.pdf')
pdfLopivi.save(outputPath1)
console.log(`‚úÖ Gu√≠a LOPIVI Completa generada: ${outputPath1}`)

// ============================================================
// GENERAR PDF 2: GU√çA PLAN DE PROTECCI√ìN
// ============================================================
console.log('\nüìó Generando Gu√≠a Plan de Protecci√≥n...')

const pdfPlan = new jsPDF()

addPortada(
  pdfPlan,
  'Gu√≠a Plan de Protecci√≥n',
  'Documento t√©cnico de referencia para el dise√±o e implantaci√≥n de Planes de Protecci√≥n'
)

const contenidoPlan = [
  {
    titulo: 'Estructura del Plan de Protecci√≥n',
    contenido: [
      'El Plan de Protecci√≥n es el documento operativo fundamental de protecci√≥n.',
      '### 1. Portada y Declaraci√≥n de Compromiso',
      'Documento oficial que refleja el compromiso de la entidad.',
      '### 2. Marco Legal y Alcance',
      'Referencia normativa y √°mbito de aplicaci√≥n.',
      '### 3. Pol√≠tica de Protecci√≥n y C√≥digo de Conducta',
      'Principios rectores y normas de comportamiento.',
      '### 4. An√°lisis de Riesgos Espec√≠ficos',
      'Identificaci√≥n sistem√°tica seg√∫n actividades.',
      '### 5. Medidas Preventivas y Correctivas',
      'Acciones para prevenir y corregir.',
      '### 6. Protocolos Operativos y de Emergencia',
      'Procedimientos paso a paso.',
      '### 7. Formaci√≥n, Comunicaci√≥n y Participaci√≥n',
      'Sistemas para capacitar e involucrar.',
      '### 8. Supervisi√≥n y Mejora Continua',
      'Evaluaci√≥n, auditor√≠a y actualizaci√≥n.'
    ]
  },
  {
    titulo: 'An√°lisis de Riesgos - Metodolog√≠a',
    contenido: [
      'El an√°lisis de riesgos es la base para medidas efectivas.',
      '### Paso 1: Identificar Actividades',
      '- Actividades regulares (clases, entrenamientos)',
      '- Actividades puntuales (campamentos, excursiones)',
      '- Servicios complementarios (transporte, comedor)',
      '### Paso 2: Evaluar Tipos de Riesgo',
      '- F√≠sicos: Lesiones, maltrato f√≠sico',
      '- Psicol√≥gicos: Maltrato emocional, acoso',
      '- Digitales: Ciberacoso, grooming',
      '- Ambientales: Instalaciones, espacios',
      '- Externos: Personas ajenas, entorno',
      '### Paso 3: Matriz de Riesgos',
      'Probabilidad (Baja/Media/Alta) √ó Impacto (Leve/Moderado/Grave)',
      '- CR√çTICO: Alta probabilidad + Impacto grave',
      '- ALTO: Combinaciones altas o medias-graves',
      '- MEDIO: Combinaciones intermedias',
      '- BAJO: Baja probabilidad + Impacto leve',
      '### Paso 4: Definir Controles',
      '- Controles existentes',
      '- Brechas identificadas',
      '- Controles adicionales necesarios',
      '- Responsables y plazos'
    ]
  },
  {
    titulo: 'Medidas Preventivas',
    contenido: [
      'Las medidas preventivas evitan situaciones de riesgo.',
      '### Supervisi√≥n y Ratios Adecuados',
      '- Menores de 3 a√±os: 1 adulto/4-6 menores',
      '- 3-6 a√±os: 1 adulto/8-10 menores',
      '- 6-12 a√±os: 1 adulto/10-15 menores',
      '- Mayores de 12 a√±os: 1 adulto/15-20 menores',
      '### Dise√±o de Espacios Seguros',
      '- Visibilidad: Evitar zonas ocultas',
      '- Iluminaci√≥n adecuada',
      '- Separaci√≥n por edades',
      '- Se√±alizaci√≥n clara',
      '### Control de Acceso',
      '- Registro de entradas/salidas',
      '- Identificaci√≥n de personal',
      '- Control de personas ajenas',
      '- Protocolos de recogida',
      '### Uso de Dispositivos',
      '- Normativa de m√≥viles/tablets',
      '- Prohibici√≥n fotos sin autorizaci√≥n',
      '- Protecci√≥n de datos personales',
      '- Consentimiento informado',
      '### Verificaci√≥n de Antecedentes',
      '- Certificado negativo delitos sexuales',
      '- Referencias profesionales',
      '- Periodo de prueba supervisado'
    ]
  },
  {
    titulo: 'Protocolos de Emergencia',
    contenido: [
      'Respuesta r√°pida y efectiva ante situaciones graves.',
      '### Actuaci√≥n Inmediata',
      '1. Evaluar situaci√≥n y riesgo',
      '2. Garantizar seguridad del menor',
      '3. Separar al presunto agresor',
      '4. Avisar al Delegado (inmediato)',
      '5. Contactar emergencias si procede (112)',
      '6. Documentar todo',
      '### Comunicaci√≥n Interna',
      '- Cadena de notificaci√≥n clara',
      '- Contactos actualizados',
      '- Registro escrito',
      '- Informaci√≥n compartida solo con autorizados',
      '### Comunicaci√≥n Externa',
      '- Notificaci√≥n a familias',
      '- Coordinaci√≥n Servicios Sociales',
      '- Colaboraci√≥n Fuerzas de Seguridad',
      '- Comunicaci√≥n institucional',
      '- Protecci√≥n imagen del menor',
      '### Evacuaci√≥n y Primeros Auxilios',
      '- Plan de evacuaci√≥n',
      '- Simulacros peri√≥dicos',
      '- Botiqu√≠n y personal formado',
      '- Protocolo ante accidentes',
      '### Seguimiento Post-Incidente',
      '- Evaluaci√≥n de impacto',
      '- Apoyo psicol√≥gico',
      '- Seguimiento indicaciones externas',
      '- Revisi√≥n del protocolo',
      '- Actualizaci√≥n de medidas'
    ]
  },
  {
    titulo: 'Plantillas Incluidas',
    contenido: [
      '### Plantilla 1: An√°lisis de Riesgos',
      'Tabla para documentar riesgos identificados con probabilidad, impacto, controles y responsables.',
      '### Plantilla 2: Registro de Incidencias',
      'Formulario para documentar fecha, personas implicadas, tipo, descripci√≥n, testigos, actuaciones y seguimiento.',
      '### Plantilla 3: Modelo de Notificaci√≥n',
      'Formato para notificar sospechas con datos del notificante, menor, descripci√≥n y urgencia.',
      '### Plantilla 4: Protocolo de Emergencia',
      'Lista de verificaci√≥n: seguridad garantizada, Delegado avisado, servicios contactados, documentaci√≥n, notificaci√≥n familiar, derivaci√≥n.',
      '### Plantilla 5: Checklist de Auditor√≠a',
      'Verificaci√≥n peri√≥dica del Plan: actualizaci√≥n, delegado formado, c√≥digo difundido, formaci√≥n certificada, protocolos accesibles, registros completos, auditor√≠a realizada.'
    ]
  },
  {
    titulo: 'Conclusi√≥n',
    contenido: [
      'El Plan de Protecci√≥n debe ser un documento vivo, revisado peri√≥dicamente.',
      '### Caracter√≠sticas de un Plan Eficaz',
      '- Adaptado a la realidad de la entidad',
      '- Conocido por todo el personal',
      '- Revisado anualmente',
      '- Evaluado mediante auditor√≠as',
      '- Integrado en la cultura organizacional',
      '### Errores a Evitar',
      '- Copiar plantillas gen√©ricas',
      '- Crear el plan solo formalmente',
      '- No formar al personal',
      '- No revisar ni actualizar',
      '- No documentar acciones',
      '### Custodia360: Herramienta Automatizada',
      'Custodia360 ofrece la plataforma para crear y mantener el Plan actualizado, formar y certificar personal, gestionar protocolos de forma segura, generar auditor√≠as autom√°ticas y garantizar cumplimiento en tiempo real.',
      'M√°s informaci√≥n: www.custodia360.es | info@custodia360.es | Tel: 678 771 198'
    ]
  }
]

pageNum = 2
contenidoPlan.forEach(seccion => {
  pdfPlan.addPage()
  addContenidoPagina(pdfPlan, seccion.titulo, seccion.contenido, pageNum)
  pageNum++
})

const outputPath2 = path.join(outputDir, 'guia-plan-de-proteccion.pdf')
pdfPlan.save(outputPath2)
console.log(`‚úÖ Gu√≠a Plan de Protecci√≥n generada: ${outputPath2}`)

console.log('\n‚úÖ Ambos PDFs generados exitosamente')
console.log(`üìÇ Ubicaci√≥n: ${outputDir}`)
console.log('\nüìå Pr√≥ximo paso: Subir a Supabase Storage')
